const db = require('@edwinspire/express-pgapi/pgexpress')
const passport = require('passport');
const LocalStrategy = require('passport-local');//
//const jwt = require('jsonwebtoken');
const { TOKEN_ENCRYPT } = process.env;


passport.use(new LocalStrategy({ usernameField: 'user', passwordField: 'pwd', passReqToCallback: true }, async (req, user, pwd, done) => {
    //console.log(req.body,  user, pwd);
    const myURL = new URL('https://' + req.hostname + req.originalUrl);
    let ip = req.headers['x-forwarded-for'] || req.connection.remoteAddress;

    let idata = {
        cookies: req.cookies,
        body: req.body,
        query: req.query,
        method: req.method,
        pathname: myURL.pathname,
        ipclient: ip,
        headers: req.headers
    }

    //Loguea con la base de datos
    try {

        let query = {
            name: 'signup',
            text: `SELECT api.fn_signin($1::TEXT, $2::TEXT, $3::JSON)`,
            values: [user, pwd, JSON.stringify(idata)]
        }
        let respg = await db.query(query);

        if (respg.rows.length > 0) {
            let r = respg.rows[0].fn_signin;

            if (r.login) {
     //           r.jwt = jwt.sign(r, TOKEN_ENCRYPT, { expiresIn: '1h' });
                return done(null, r);
            } else {
                return done(null, r, { message: r.message });
            }

        } else {
            return done(null, false, { message: 'No se pudo' });
        }

    } catch (error) {
        return done(error);
    }

}));


passport.serializeUser((user, done) => {
//    var token = jwt.sign(user, TOKEN_ENCRYPT, { expiresIn: '365d' });
    done(null, user);
});

passport.deserializeUser((id, done) => {
    done(null, id);
  /*
    try {
        var decoded = jwt.verify(id, TOKEN_ENCRYPT, {ignoreExpiration: true});
        console.log(id, decoded);
        done(null, decoded);
    } catch (err) {
        console.error(err);
        done(err, null);
    }
*/
});



